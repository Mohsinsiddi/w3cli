package chain

import (
	"encoding/hex"
	"fmt"
	"math/big"
	"strings"
)

// ----------------------------------------------------------------------------
// W3Token — OpenZeppelin v5.5.0 ERC-20 (Mintable + Burnable + Ownable)
// Compiled: solc 0.8.26, optimizer 200 runs, EVM: cancun
// Source (Solidity):
//
//	// SPDX-License-Identifier: MIT
//	pragma solidity ^0.8.22;
//
//	import {ERC20}         from "@openzeppelin/contracts/token/ERC20/ERC20.sol";
//	import {ERC20Burnable} from "@openzeppelin/contracts/token/ERC20/extensions/ERC20Burnable.sol";
//	import {Ownable}       from "@openzeppelin/contracts/access/Ownable.sol";
//
//	/// @title W3Token — mintable & burnable ERC-20 deployed by w3cli
//	contract W3Token is ERC20, ERC20Burnable, Ownable {
//	    uint8 private _decimals;
//
//	    constructor(
//	        string memory tokenName,
//	        string memory tokenSymbol,
//	        uint8  tokenDecimals,
//	        uint256 initialSupply
//	    ) ERC20(tokenName, tokenSymbol) Ownable(msg.sender) {
//	        _decimals = tokenDecimals;
//	        _mint(msg.sender, initialSupply);   // mints initialSupply to deployer
//	    }
//
//	    // Override to expose custom decimals (default OZ ERC20 is 18).
//	    function decimals() public view virtual override returns (uint8) {
//	        return _decimals;
//	    }
//
//	    // Owner-only mint — lets the deployer mint additional tokens later.
//	    function mint(address to, uint256 amount) external onlyOwner {
//	        _mint(to, amount);
//	    }
//
//	    // burn() and burnFrom() are inherited from ERC20Burnable.
//	    // Any holder can burn their own tokens; burnFrom requires approval.
//	}
//
// ABI-relevant constructor:
//
//	constructor(string tokenName, string tokenSymbol, uint8 tokenDecimals, uint256 initialSupply)
//
// Storage layout:
//
//	slot 0  — ERC20 _balances   (mapping)
//	slot 1  — ERC20 _allowances (mapping)
//	slot 2  — ERC20 _totalSupply
//	slot 3  — ERC20 _name       (string)
//	slot 4  — ERC20 _symbol     (string)
//	slot 5  — Ownable _owner + _decimals (packed: address 20 b + uint8 1 b)
// ----------------------------------------------------------------------------

// w3TokenBytecode is the init bytecode (constructor + runtime) for W3Token.
// Append ABI-encoded constructor args before deployment.
const w3TokenBytecode = "608060405234801561000f575f80fd5b50604051610e61380380610e6183398101604081905261002e91610311565b338484600361003d8382610418565b50600461004a8282610418565b5050506001600160a01b03811661007b57604051631e4fbdf760e01b81525f60048201526024015b60405180910390fd5b610084816100b0565b506005805460ff60a01b1916600160a01b60ff8516021790556100a73382610101565b505050506104f7565b600580546001600160a01b038381166001600160a01b0319831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0905f90a35050565b6001600160a01b03821661012a5760405163ec442f0560e01b81525f6004820152602401610072565b6101355f8383610139565b5050565b6001600160a01b038316610163578060025f82825461015891906104d2565b909155506101d39050565b6001600160a01b0383165f90815260208190526040902054818110156101b55760405163391434e360e21b81526001600160a01b03851660048201526024810182905260448101839052606401610072565b6001600160a01b0384165f9081526020819052604090209082900390555b6001600160a01b0382166101ef5760028054829003905561020d565b6001600160a01b0382165f9081526020819052604090208054820190555b816001600160a01b0316836001600160a01b03167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef8360405161025291815260200190565b60405180910390a3505050565b634e487b7160e01b5f52604160045260245ffd5b5f82601f830112610282575f80fd5b81516001600160401b0381111561029b5761029b61025f565b604051601f8201601f19908116603f011681016001600160401b03811182821017156102c9576102c961025f565b6040528181528382016020018510156102e0575f80fd5b5f5b828110156102fe576020818601810151838301820152016102e2565b505f918101602001919091529392505050565b5f805f8060808587031215610324575f80fd5b84516001600160401b03811115610339575f80fd5b61034587828801610273565b602087015190955090506001600160401b03811115610362575f80fd5b61036e87828801610273565b935050604085015160ff81168114610384575f80fd5b6060959095015193969295505050565b600181811c908216806103a857607f821691505b6020821081036103c657634e487b7160e01b5f52602260045260245ffd5b50919050565b601f82111561041357805f5260205f20601f840160051c810160208510156103f15750805b601f840160051c820191505b81811015610410575f81556001016103fd565b50505b505050565b81516001600160401b038111156104315761043161025f565b6104458161043f8454610394565b846103cc565b6020601f821160018114610477575f83156104605750848201515b5f19600385901b1c1916600184901b178455610410565b5f84815260208120601f198516915b828110156104a65787850151825560209485019460019092019101610486565b50848210156104c357868401515f19600387901b60f8161c191681555b50505050600190811b01905550565b808201808211156104f157634e487b7160e01b5f52601160045260245ffd5b92915050565b61095d806105045f395ff3fe608060405234801561000f575f80fd5b50600436106100f0575f3560e01c806370a082311161009357806395d89b411161006357806395d89b41146101ff578063a9059cbb14610207578063dd62ed3e1461021a578063f2fde38b14610252575f80fd5b806370a08231146101a1578063715018a6146101c957806379cc6790146101d15780638da5cb5b146101e4575f80fd5b806323b872dd116100ce57806323b872dd14610147578063313ce5671461015a57806340c10f191461017957806342966c681461018e575f80fd5b806306fdde03146100f4578063095ea7b31461011257806318160ddd14610135575b5f80fd5b6100fc610265565b60405161010991906107a0565b60405180910390f35b610125610120366004610806565b6102f5565b6040519015158152602001610109565b6002545b604051908152602001610109565b61012561015536600461082e565b61030e565b600554600160a01b900460ff1660405160ff9091168152602001610109565b61018c610187366004610806565b610331565b005b61018c61019c366004610868565b610347565b6101396101af36600461087f565b6001600160a01b03165f9081526020819052604090205490565b61018c610354565b61018c6101df366004610806565b610367565b6005546040516001600160a01b039091168152602001610109565b6100fc61037c565b610125610215366004610806565b61038b565b61013961022836600461089f565b6001600160a01b039182165f90815260016020908152604080832093909416825291909152205490565b61018c61026036600461087f565b610398565b606060038054610274906108d0565b80601f01602080910402602001604051908101604052809291908181526020018280546102a0906108d0565b80156102eb5780601f106102c2576101008083540402835291602001916102eb565b820191905f5260205f20905b8154815290600101906020018083116102ce57829003601f168201915b5050505050905090565b5f336103028185856103d7565b60019150505b92915050565b5f3361031b8582856103e9565b610326858585610465565b506001949350505050565b6103396104c2565b61034382826104ef565b5050565b6103513382610523565b50565b61035c6104c2565b6103655f610557565b565b6103728233836103e9565b6103438282610523565b606060048054610274906108d0565b5f33610302818585610465565b6103a06104c2565b6001600160a01b0381166103ce57604051631e4fbdf760e01b81525f60048201526024015b60405180910390fd5b61035181610557565b6103e483838360016105a8565b505050565b6001600160a01b038381165f908152600160209081526040808320938616835292905220545f1981101561045f578181101561045157604051637dc7a0d960e11b81526001600160a01b038416600482015260248101829052604481018390526064016103c5565b61045f84848484035f6105a8565b50505050565b6001600160a01b03831661048e57604051634b637e8f60e11b81525f60048201526024016103c5565b6001600160a01b0382166104b75760405163ec442f0560e01b81525f60048201526024016103c5565b6103e483838361067a565b6005546001600160a01b031633146103655760405163118cdaa760e01b81523360048201526024016103c5565b6001600160a01b0382166105185760405163ec442f0560e01b81525f60048201526024016103c5565b6103435f838361067a565b6001600160a01b03821661054c57604051634b637e8f60e11b81525f60048201526024016103c5565b610343825f8361067a565b600580546001600160a01b038381166001600160a01b0319831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0905f90a35050565b6001600160a01b0384166105d15760405163e602df0560e01b81525f60048201526024016103c5565b6001600160a01b0383166105fa57604051634a1406b160e11b81525f60048201526024016103c5565b6001600160a01b038085165f908152600160209081526040808320938716835292905220829055801561045f57826001600160a01b0316846001600160a01b03167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9258460405161066c91815260200190565b60405180910390a350505050565b6001600160a01b0383166106a4578060025f8282546106999190610908565b909155506107149050565b6001600160a01b0383165f90815260208190526040902054818110156106f65760405163391434e360e21b81526001600160a01b038516600482015260248101829052604481018390526064016103c5565b6001600160a01b0384165f9081526020819052604090209082900390555b6001600160a01b0382166107305760028054829003905561074e565b6001600160a01b0382165f9081526020819052604090208054820190555b816001600160a01b0316836001600160a01b03167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef8360405161079391815260200190565b60405180910390a3505050565b602081525f82518060208401525f5b818110156107cc57602081860181015160408684010152016107af565b505f604082850101526040601f19601f83011684010191505092915050565b80356001600160a01b0381168114610801575f80fd5b919050565b5f8060408385031215610817575f80fd5b610820836107eb565b946020939093013593505050565b5f805f60608486031215610840575f80fd5b610849846107eb565b9250610857602085016107eb565b929592945050506040919091013590565b5f60208284031215610878575f80fd5b5035919050565b5f6020828403121561088f575f80fd5b610898826107eb565b9392505050565b5f80604083850312156108b0575f80fd5b6108b9836107eb565b91506108c7602084016107eb565b90509250929050565b600181811c908216806108e457607f821691505b60208210810361090257634e487b7160e01b5f52602260045260245ffd5b50919050565b8082018082111561030857634e487b7160e01b5f52601160045260245ffdfea264697066735822122026aacaddbc2d0f327c1d3cfa1b42f796424773561f4fc7915bccd85de44ad33464736f6c634300081a0033"

// BuildERC20DeployData ABI-encodes the constructor arguments for W3Token and
// appends them to the init bytecode, producing the full deployment payload.
//
// Constructor ABI:
//
//	constructor(string tokenName, string tokenSymbol, uint8 tokenDecimals, uint256 initialSupply)
//
// Encoding (ABI head/tail layout for dynamic types):
//
//	offset 0x00  — head[0]: offset to name   data  (0x80)
//	offset 0x20  — head[1]: offset to symbol data
//	offset 0x40  — head[2]: tokenDecimals    (uint8, padded to 32 bytes)
//	offset 0x60  — head[3]: initialSupply    (uint256)
//	offset 0x80  — name   length + bytes (padded to 32-byte boundary)
//	offset ...   — symbol length + bytes (padded to 32-byte boundary)
func BuildERC20DeployData(name, symbol string, decimals uint8, supply *big.Int) ([]byte, error) {
	initCode, err := hex.DecodeString(w3TokenBytecode)
	if err != nil {
		return nil, fmt.Errorf("decoding bytecode: %w", err)
	}

	// ABI-encode the constructor args manually (no external dependency).
	nameBytes := []byte(name)
	symbolBytes := []byte(symbol)

	// Each string encodes as: 32-byte length + padded data.
	nameEncLen := 32 + roundUp32(len(nameBytes))
	symEncLen := 32 + roundUp32(len(symbolBytes))

	// Head: 4 × 32-byte words (two offsets + decimals + supply).
	//   head[0] = offset to name   = 4*32 = 0x80
	//   head[1] = offset to symbol = 0x80 + nameEncLen
	//   head[2] = decimals (uint8)
	//   head[3] = initialSupply (uint256)
	const headBytes = 4 * 32
	nameOffset := headBytes
	symOffset := headBytes + nameEncLen

	args := make([]byte, 0, headBytes+nameEncLen+symEncLen)

	args = appendUint256(args, uint64(nameOffset))
	args = appendUint256(args, uint64(symOffset))

	// decimals: uint8 right-padded to 32 bytes
	dec256 := make([]byte, 32)
	dec256[31] = decimals
	args = append(args, dec256...)

	// initialSupply: uint256
	args = appendBigInt(args, supply)

	// name data
	args = appendString(args, nameBytes)

	// symbol data
	args = appendString(args, symbolBytes)

	return append(initCode, args...), nil
}

// ────────────────────────── ABI encoding helpers ─────────────────────────────

func roundUp32(n int) int {
	if n%32 == 0 {
		return n
	}
	return n + (32 - n%32)
}

func appendUint256(buf []byte, v uint64) []byte {
	word := make([]byte, 32)
	// big-endian uint64 in the last 8 bytes
	word[24] = byte(v >> 56)
	word[25] = byte(v >> 48)
	word[26] = byte(v >> 40)
	word[27] = byte(v >> 32)
	word[28] = byte(v >> 24)
	word[29] = byte(v >> 16)
	word[30] = byte(v >> 8)
	word[31] = byte(v)
	return append(buf, word...)
}

func appendBigInt(buf []byte, v *big.Int) []byte {
	word := make([]byte, 32)
	vBytes := v.Bytes()
	copy(word[32-len(vBytes):], vBytes)
	return append(buf, word...)
}

func appendString(buf []byte, data []byte) []byte {
	// length word
	buf = appendUint256(buf, uint64(len(data)))
	// data + zero padding to 32-byte boundary
	buf = append(buf, data...)
	pad := roundUp32(len(data)) - len(data)
	buf = append(buf, make([]byte, pad)...)
	return buf
}

// W3TokenMintCalldata builds the calldata for mint(address,uint256).
// Selector: 0x40c10f19
func W3TokenMintCalldata(toAddr string, amount *big.Int) []byte {
	selector := []byte{0x40, 0xc1, 0x0f, 0x19}
	addrWord := make([]byte, 32)
	addrBytes, _ := hex.DecodeString(strings.TrimPrefix(toAddr, "0x"))
	copy(addrWord[12:], addrBytes)
	amountWord := make([]byte, 32)
	ab := amount.Bytes()
	copy(amountWord[32-len(ab):], ab)
	out := make([]byte, 0, 4+64)
	out = append(out, selector...)
	out = append(out, addrWord...)
	out = append(out, amountWord...)
	return out
}

// W3TokenBurnCalldata builds the calldata for burn(uint256).
// Selector: 0x42966c68
func W3TokenBurnCalldata(amount *big.Int) []byte {
	selector := []byte{0x42, 0x96, 0x6c, 0x68}
	amountWord := make([]byte, 32)
	ab := amount.Bytes()
	copy(amountWord[32-len(ab):], ab)
	out := make([]byte, 0, 4+32)
	out = append(out, selector...)
	out = append(out, amountWord...)
	return out
}
